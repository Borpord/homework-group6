# MPT树

MPT（Merkle Patricia Trie）树，即默克尔前缀树，相当于是默克尔树与前缀树的结合。因此，在下文中首先分别介绍一下默克尔树与前缀树。

## 默克尔树

默克尔树是由一批叶子节点构建得到的，即首先分别计算出各个叶子节点所对应的HASH值，之后将相邻两个叶子节点的哈希值进行级联，作为新的输入计算上一层父节点所存储的HASH值，并一直计算到根节点为止。

当然，如上所述的情况要求叶子节点个数是偶数，才可以实现两两合并的操作。若叶子节点个数是奇数，可以复制单节点的哈希值再进行合并操作，亦可将单独多出来的叶子节点作为新计算的哈希值进入上一层。

<img src=".\md_image\1.png" alt="image-20230708235635449" style="zoom: 80%;" />

## 前缀树

即一种有序多叉树，可以根据每条数据的部分前缀的关键词有序性来实现快速查找的目的。

## MPT（Merkle Patricia Trie）树

MPT树相当于如上所述的默克尔树和前缀树的结合。

MPT树的结点总共有以下四种类型：

| 节点类型                   | 节点描述         |
| -------------------------- | ---------------- |
| 扩展节点（Extension Node） | 只有一个子节点   |
| 分支节点（Branch Node）    | 可以有多个子节点 |
| 叶子节点（Leaf Node）      | 没有子节点       |
| 空节点                     | 空字符串         |

其中每个节点最多只有可能存储了三种内容：Key，Val与nodeFlag，其中Key代表了该节点所对应范围的key，Val用来存储该节点的内容，nodeFlag则用于指示该节点所属的类型。

### MPT树的增删查操作

#### 增删查改——查：

根据所给定的Key，从根节点开始查找与搜寻范围一致的节点路径：

1.若当前节点为叶子节点，存储的内容是Val，且Key一致，则认为找到该节点，否则认为要找的Key在MPT树中不存在。

2.若当前节点为分支节点，若搜索路径为空则返回该节点，否则利用搜索路径关键词继续向下搜索。

3.若当前节点为扩展节点，存储的内容是哈希索引，则使用该哈希索引加载该节点，对新解析出来的节点继续使用路径参数向下查找。

4.若当前节点为扩展节点，存储的内容是对于另外一个节点的引用，且当前节点的key为要搜索路径的前缀，则继续向下递归查找，否则要查找的节点在MPT树中不存在。

#### 增删查改——改：

基于查找操作实现，找到要修改的节点之后修改其内容即可。

#### 增删查改——增：

插入操作是基于查找操作完成的，首先需要查找到与新插入节点拥有最长相同路径前缀的节点。

1.若该节点是分支节点：

(1)剩余搜索路径为空：将新插入节点的内容放入分支节点的孩子节点当中。

(2)剩余搜索路径不为空：将新插入节点作为叶子节点插入到对应的孩子列表当中。

2.若该节点为叶子/扩展节点：

(1)剩余的搜索路径与当前节点key一致，将当前节点的val更新。

(2)剩余的搜索路径与当前节点key不一致，将叶子／扩展节点的孩子节点替换成分支节点，将新节点与当前节点key的共同前缀作为当前节点的key，将新节点与当前节点的孩子节点作为两个孩子插入到分支节点的孩子列表中，同时当前节点转换成了一个扩展节点（若新节点与当前节点没有共同前缀，则直接用生成的分支节点替换当前节点）。

#### 增删查改——删：

插入操作是基于查找操作完成的，首先需要查找到要删除的节点。

如果该节点（Node）是一个叶子节点或扩展节点：

- 如果剩余的搜索路径与节点（Node）的键（Key）完全匹配，则删除整个节点（Node）。
- 如果剩余的搜索路径与节点（Node）的键（Key）不匹配，则表示要删除的节点不在树中，删除操作失败。
- 如果节点（Node）的键（Key）是剩余搜索路径的前缀，则对该节点（Node）的值（Val）进行递归删除操作。 如果节点（Node）是一个分支节点：
- 删除孩子列表中相应下标标记的节点。
- 删除完成后，如果节点（Node）的孩子个数只剩下一个，将该分支节点替换为一个叶子节点或扩展节点。

### MPT树的特点

MPT（Merkle Patricia Tree）树是一种用于存储和验证数据的数据结构，广泛用于区块链技术中。MPT树的一大特点便是回滚性，是指在进行数据更新或删除操作时，即使操作后的数据发生了改变，原先的数据状态仍然可以被恢复，而不会丢失或受到破坏。

MPT树实现回滚性的主要机制是通过使用哈希函数来存储数据，将每个节点的哈希值与其内容相关联。当对数据进行插入、更新或删除操作时，MPT树会在内部进行相应的修改，而不是直接对原始数据进行改动。每次修改都会创建一个新的节点，并通过计算哈希值来反映这种变化。

当需要回滚到之前的数据状态时，MPT树可以通过逐级检查节点哈希值的一致性，从根节点开始向下遍历树结构。如果发现节点的哈希值与存储在树中的哈希值不匹配，这意味着树中的数据已经被修改，系统将回溯到先前的树状态。通过这种方式，MPT树能够保持数据的完整性，并实现高度的回滚性，从而确保了数据的可靠性和安全性。
